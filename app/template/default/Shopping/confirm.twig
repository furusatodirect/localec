{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends 'default_frame.twig' %}

{% form_theme form 'Form/form_div_layout.twig' %}

{% block main %}

    <div class="ec-role">
        <div class="ec-pageHeader">
            <h1>{{ 'front.shopping.confirm_title'|trans }}</h1>
        </div>
    </div>

    <div class="ec-cartRole">
        <div class="ec-cartRole__progress">
            <ul class="ec-progress">
                {% set step = 1 %}
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">選択したお礼の品
                    </div>
                </li>
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">申込手続き
                    </div>
                </li>
                <li class="ec-progress__item is-complete">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">入力確認
                    </div>
                </li>
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">完了
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <form id="shopping-form" method="post" action="{{ url('shopping_checkout') }}">
    {{ form_widget(form._token) }}
    <div class="ec-orderRole">
        <div class="ec-orderRole__detail">

            {# ===== お申込者情報 ===== #}
            <div class="ec-orderAccount">
                <div class="ec-rectHeading">
                    <h2>{{ 'front.shopping.customer_info'|trans }}</h2>
                </div>
                <div class="ec-orderAccount__account">
                    <p>控除対象者と一致しているかご確認ください。</p>
                    <table>
                        <tr>
                            <th>お名前︓</th>
                            <td>{{ 'common.name.prefix'|trans }}{{ Order.name01 }} {{ Order.name02 }}{{ 'common.name.suffix'|trans }}</td>
                        </tr>
                        <tr>
                            <th>お名前カナ︓</th>
                            <td>{{ Order.kana01 }} {{ Order.kana02 }}様</td>
                        </tr>
                        <tr>
                            <th>郵便番号︓</th>
                            <td>{{ 'common.postal_symbol'|trans }}{{ Order.postal_code }}</td>
                        </tr>
                        <tr>
                            <th>住所︓</th>
                            <td>{{ Order.pref }}{{ Order.addr01 }}<br>{{ Order.addr02 }}</td>
                        </tr>
                        <tr>
                            <th>電話番号︓</th>
                            <td>{{ Order.phone_number }}</td>
                        </tr>
                        <tr>
                            <th>メールアドレス︓</th>
                            <td>{{ Order.email }}</td>
                        </tr>
                        <tr>
                            <th>生年月日︓</th>
                            <td>{{ Order.birth|date('Y年m月d日', 'Asia/Tokyo') }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            {# ===== お礼の品とお届け先 ===== #}
            <div class="ec-orderDelivery">
                <div class="ec-rectHeading">
                    <h2>お礼の品とお届け先</h2>
                </div>
                {% for shipping in Order.shippings %}
                    {% set idx = loop.index0 %}
                    {% set isShowReducedTaxMess = false %}
                    <div class="ec-orderDelivery__item">
                        <ul class="ec-borderedList">
                            {% for orderItem in shipping.productOrderItems %}
                            <li>
                                <div class="ec-imageGrid">
                                    <div class="ec-imageGrid__img">
                                        <img src="{{ asset((orderItem.product is null ? null : orderItem.product.MainListImage)|no_image_product, 'save_image') }}" alt="{{ orderItem.productName }}" loading="lazy">
                                    </div>
                                    <div class="ec-imageGrid__content">
                                        <p>{{ orderItem.productName }}{% if is_reduced_tax_rate(orderItem) %}{{ 'common.reduced_tax_rate_symbol'|trans }}{% set isShowReducedTaxMess = true %}{% endif %}</p>
                                        {% if orderItem.productClass is not null and orderItem.productClass.classCategory1 %}
                                            <p>{{ orderItem.productClass.classCategory1.className.name }}：{{ orderItem.productClass.classCategory1 }}</p>
                                        {% endif %}
                                        {% if orderItem.productClass is not null and orderItem.productClass.classCategory2 %}
                                            <p>{{ orderItem.productClass.classCategory2.className.name }}：{{ orderItem.productClass.classCategory2 }}</p>
                                        {% endif %}
                                        <p>{{ orderItem.priceIncTax|price }} × {{ orderItem.quantity|number_format }}<span>{{ 'common.subtotal__with_separator'|trans }}{{ orderItem.totalPrice|price }}</span></p>
                                    </div>
                                </div>
                                {# Custom: 配送方法・お届け先情報 #}
                                <table>
                                    {% if orderItem.product is not null and orderItem.product.room_temperature_delivery == '1' %}
                                    <tr>
                                        <th>配送方法︓</th>
                                        <td>常温配送</td>
                                    </tr>
                                    {% elseif orderItem.product is not null and orderItem.product.refrigerated_delivery == '1' %}
                                    <tr>
                                        <th>配送方法︓</th>
                                        <td>冷蔵配送</td>
                                    </tr>
                                    {% elseif orderItem.product is not null and orderItem.product.frozen_delivery == '1' %}
                                    <tr>
                                        <th>配送方法︓</th>
                                        <td>冷凍配送</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <th>お名前︓</th>
                                        <td>{{ shipping.name01 }} {{ shipping.name02 }}様</td>
                                    </tr>
                                    <tr>
                                        <th>お名前カナ︓</th>
                                        <td>{{ shipping.kana01 }} {{ shipping.kana02 }}様</td>
                                    </tr>
                                    <tr>
                                        <th>郵便番号︓</th>
                                        <td>〒{{ shipping.postal_code }}</td>
                                    </tr>
                                    <tr>
                                        <th>住所︓</th>
                                        <td>{{ shipping.pref }}{{ shipping.addr01 }}<br>{{ shipping.addr02 }}</td>
                                    </tr>
                                    <tr>
                                        <th>電話番号︓</th>
                                        <td>{{ shipping.phone_number }}</td>
                                    </tr>
                                </table>
                            </li>
                            {% endfor %}
                        </ul>
                        <p>{{ isShowReducedTaxMess ? 'common.reduced_tax_rate_messeage'|trans }}</p>
                    </div>
                    <div class="ec-orderDelivery__address">
                        <p>{{ 'common.name.prefix'|trans }}{{ shipping.name01 }} {{ shipping.name02 }} ({{ shipping.kana01 }} {{ shipping.kana02 }}){{ 'common.name.suffix'|trans }}</p>
                        <p>{{ 'common.postal_symbol'|trans }}{{ shipping.postal_code }} {{ shipping.pref }}{{ shipping.addr01 }}{{ shipping.addr02 }}</p>
                        <p>{{ shipping.phone_number }}</p>
                    </div>
                    <div class="ec-orderDelivery__actions">
                        <div class="ec-selects">
                            <div class="ec-select">
                                <label>{{ 'front.shopping.delivery_provider'|trans }}</label>
                                {% set delivery_fee = 0 %}
                                {% for item in shipping.order_items|filter(item => item.isDeliveryFee) %}
                                    {% set delivery_fee = item.total_price %}
                                {% endfor %}
                                {{ Order.Shippings[idx].Delivery }}({{ delivery_fee|price }})
                            </div>
                            <div class="ec-select ec-select__delivery">
                                <label>{{ 'front.shopping.delivery_date'|trans }}</label>
                                {{ Order.Shippings[idx].shipping_delivery_date ? Order.Shippings[idx].shipping_delivery_date|date_day_with_weekday : 'common.select__unspecified'|trans }}
                            </div>
                            <div class="ec-select ec-select__time">
                                <label>{{ 'front.shopping.delivery_time'|trans }}</label>
                                {{ Order.Shippings[idx].shipping_delivery_time ?: 'common.select__unspecified'|trans }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <p class="shipping-info">寄附証明書などの書類はお申込者のご住所にお送りいたします。</p>
            </div>

            {# ===== お支払い方法 ===== #}
            <div class="ec-orderPayment">
                <div class="ec-rectHeading">
                    <h2>お支払い方法と金額</h2>
                </div>
                <div class="ec-rectHeading">
                    <h3>お支払い方法</h3>
                </div>
                <div class="ec-blockRadio">
                    {% set charge = 0 %}
                    {% for item in Order.order_items|filter(item => item.isCharge) %}
                        {% set charge = item.total_price %}
                    {% endfor %}
                    {{ Order.Payment }}({{ charge|price }})
                </div>
            </div>

            {# ===== ポイント情報 ===== #}
            {% if BaseInfo.isOptionPoint and Order.Customer is not null %}
            <div class="ec-orderPayment">
                <div class="ec-rectHeading">
                    <h2>{{ 'front.shopping.point_info'|trans }}</h2>
                </div>
                <div class="ec-blockRadio">
                    {{ Order.use_point|number_format }} pt
                </div>
            </div>
            {% endif %}

            {# ===== 寄付情報 ===== #}
            <div class="ec-orderConfirm">
                <div class="ec-rectHeading">
                    <h2>寄付情報</h2>
                </div>
                <div class="ec-rectHeading">
                    <h3>寄付金の使い道</h3>
                </div>
                <div class="ec-select">
                    <p>{{ Order.DonationPurpose }}</p>
                </div>
                <div class="ec-rectHeading">
                    <h3>ワンストップ特例制度</h3>
                </div>
                <div class="ec-checkbox">
                    <p>{{ Order.one_stop ? '申請書を要望する' : '申請書を要望しない' }}</p>
                </div>
                <div class="ec-rectHeading">
                    <h3>紋別市への応援メッセージ</h3>
                </div>
                <div class="ec-input">
                    <p>{{ Order.cheer_message }}</p>
                    <br>
                    <p>{{ Order.cheer_message_publish ? '応援メッセージを公表して良い' : '応援メッセージを公表しない' }}</p>
                </div>
                <div class="ec-rectHeading">
                    <h3>寄付者名の公表</h3>
                </div>
                <div class="ec-input">
                    <p>{{ Order.name_announce ? '寄付者名を公表して良い' : '寄付者名を公表しない' }}</p>
                </div>
                <div class="ec-rectHeading">
                    <h3>備考欄</h3>
                </div>
                <div class="ec-input">
                    {{ Order.offer_memo }}
                </div>
            </div>

            {# ===== 特定商取引法に基づく表記 (4.3) ===== #}
            {% for activeTradeLaw in activeTradeLaws|filter(t => t.name and t.description) %}
                <div class="ec-orderConfirm">
                    <div class="ec-rectHeading">
                        <h2>{{ activeTradeLaw.name }}</h2>
                    </div>
                    <div class="ec-input">
                        {{ activeTradeLaw.description|raw }}
                    </div>
                </div>
            {% endfor %}

            {# ===== 注意事項 ===== #}
            <div class="one_stop-attention">
                <label>注意事項</label>
                <p>★必ず、以下の事項をご了承のうえお申込みください。</p>
                <ul>
                    <li>お申し込みお手続きは、必ず控除対象者さまのご名義で行ってください。</li>
                    <li>寄附方法は、クレジットカード決済限定です。お申込者本人のクレジットカードのみご利用できます。</li>
                    <li>寄付の変更およびキャンセルは、いかなる理由でもお受けできません。</li>
                    <li>お礼の品、配送月の変更はお受けできません。</li>
                    <li>配送日、曜日、配送業者の指定はお受けできません。</li>
                    <li>配送業者での保管期間を過ぎた場合、再配送はいたしません。</li>
                    <li>農産物については、天候等の影響でご希望の配送月を前後する場合がございます。また、災害等によりお届け不能となった場合は、他のお礼品に変更をお願いする場合がございます。</li>
                    <li>お受け取りのお礼品につきましては、到着後直ぐに状態をご確認いただき、不具合のあった場合は早急にご連絡ください。<br>
                    お日にちを経過してのご連絡は対応いたしかねます。</li>
                </ul>
            </div>

            <div class="donate-checkbox last-input">
                <input type="checkbox" required="required" id="agreement2">
                <p><label for="agreement2">寄付の変更・キャンセルはいたしません。</label></p>
            </div>
        </div>
        <div class="ec-orderRole__summary">
            <div class="ec-rectHeading">
                <h3>寄付金額</h3>
            </div>
            <div class="ec-totalBox">
                <dl class="ec-totalBox__spec">
                    <dt>{{ 'common.subtotal'|trans }}</dt>
                    <dd class="ec-totalBox__specTotal">{{ Order.subtotal|price }}</dd>
                </dl>
                <dl class="ec-totalBox__spec">
                    <dt>{{ 'common.charge'|trans }}</dt>
                    <dd>{{ Order.charge|price }}</dd>
                </dl>
                <dl class="ec-totalBox__spec">
                    <dt>{{ 'common.delivery_fee'|trans }}</dt>
                    <dd>{{ Order.deliveryFeeTotal|price }}</dd>
                </dl>
                {% if Order.taxable_discount < 0 %}
                <dl class="ec-totalBox__spec">
                    <dt>{{ 'common.discount'|trans }}</dt>
                    <dd>{{ Order.taxable_discount|price }}</dd>
                </dl>
                {% endif %}
                <div class="ec-totalBox__total">{{ 'common.total'|trans }}<span class="ec-totalBox__price">{{ Order.taxable_total|price }}</span><span class="ec-totalBox__taxLabel">{{ 'common.tax_include'|trans }}</span></div>
                {% for item in Order.tax_free_discount_items %}
                    <dl class="ec-totalBox__spec">
                        <dt>{{ item.product_name }}</dt>
                        <dd>{{ item.total_price|price }}</dd>
                    </dl>
                {% endfor %}
                <div class="ec-totalBox__paymentTotal">{{ Order.payment_total|number_format }}円</div>
                {% for rate, total in Order.total_by_tax_rate %}
                    <dl class="ec-totalBox__taxRate">
                        <dt>{{ 'common.tax_rate_target'|trans({ '%rate%': rate }) }}</dt>
                        <dd>{{ total|price }} ({{ 'common.tax_amount'|trans }} {{ Order.tax_by_tax_rate[rate]|price }})</dd>
                    </dl>
                {% endfor %}
                {% if BaseInfo.isOptionPoint and Order.Customer is not null %}
                <div class="ec-totalBox__pointBlock">
                    <dl class="ec-totalBox__spec">
                        <dt>{{ 'front.shopping.use_point'|trans }}</dt>
                        <dd>{{ Order.UsePoint|number_format }} pt</dd>
                    </dl>
                    <dl class="ec-totalBox__spec">
                        <dt><span class="ec-font-bold">{{ 'front.shopping.add_point'|trans }}</span></dt>
                        <dd><span class="ec-font-bold">{{ Order.AddPoint|number_format }} pt</span></dd>
                    </dl>
                </div>
                {% endif %}
                <div class="ec-totalBox__btn">
                    <button type="submit" class="ec-blockBtn--action">カード決済画面へ進む</button>
                    <a href="{{ url('shopping') }}" class="ec-blockBtn--cancel">前の画面に戻る</a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
