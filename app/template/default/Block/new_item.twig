{% set Products = CustomizeNewProduct() %}

{% if Products|length > 0 %}
<div class="container">

<section class="newgift">
<h3>新着のお礼の品</h3>
<ul class="p-box">
{% for Product in Products %}
{#author :MT start#}
    {% if Product.out_of_print == 0 %}
        {% if (Product.published_at_from  <= date() or Product.published_at_from == null) and (Product.published_at_to  > date() or Product.published_at_to == null) %}
            {% set publish_p =1 %}
        {% else %}
            {% set publish_p =0 %}
        {% endif %}
    {% else %}
        {% set publish_p =0 %}
    {% endif %}
{% if publish_p == 1 %}
{#author :MT end#}
<li>
    
{#author :MT start #}
    {#{% include '@ProductListFavBtn4/favorite.twig' ignore missing with {'Product': Product} %}#}
    {#{% include '@ProductListFavBtn4/api/favorite.twig' ignore missing with {'Product': Product} %}#}
    {% if BaseInfo.option_favorite_product %}
        {% if app.user %}
            {%
                set is_favorite = repository("Eccube\\Entity\\CustomerFavoriteProduct")
                .isFavorite(app.user, Product)
            %}
            {% if is_favorite == false %}
            <button id="favorite" class="favorite"
                    url="{{ url('plg_product_favorite_api_add', { id : Product.id }) }}" {{ csrf_token_for_anchor() }}
                    data-method="post" data-product_id="{{ Product.id }}">
                <i class="fa-sharp fa-solid fa-heart" style="color: gray;"></i>
            </button>
            {% else %}
            <button id="favorite" class="favorite"
                    url="{{ url('plg_product_favorite_api_delete', { id : Product.id }) }}" {{ csrf_token_for_anchor() }}
                    data-method="delete" data-product_id="{{ Product.id }}">
                <i class="fa-sharp fa-solid fa-heart" style="color: #FF004E;"></i>
            </button>
            {% endif %}
        {% else %}
            <button id="favorite" class="favorite"
                url="{{ url('plg_product_favorite_api_add') }}" {{ csrf_token_for_anchor() }}
                data-method="post" data-product_id="{{ Product.id }}">
            <i class="fa-sharp fa-solid fa-heart" style="color: gray;"></i>
        </button>
        {% endif %}
        
    {% endif %}
    {#author :MT end #}
<a href="{{ url('product_detail', {'id': Product.id}) }}">
<div class="mask">
    
{#author :MT start#}
{% if  Product.applicable_on_from != null and Product.applicable_on_from > date() %}
<div class="status-wrap"><p>{{Product.applicable_on_from|date_format('', 'm月d日')}}より<br>受付開始</p></div>
{% elseif Product.applicable_on_to != null and Product.applicable_on_to < date() %}
<div class="status-wrap"><p>受付終了</p></div>
{% elseif Product.stock_find == 0 or Product.out_of_stock == 1 %}
<div class="status-wrap"><p>品切れ中</p></div>
{% endif %}
{#author :MT end#}

<img class="b-pic" src="{{ asset(Product.main_list_image|no_image_product, 'save_image') }}" alt="{{ Product.name }}" loading="lazy"><div class="c-pic"><img src="{{ asset(Product.main_list_image|no_image_product, 'save_image') }}" alt="{{ Product.name }}" loading="lazy"></div>
<div class="price"><p>寄付金額<span>{{ Product.getPrice02IncTaxMin|number_format }}</span>円</p></div>
</div>
<p class="product_name">{{ Product.name }}</p>
</a>
</li>

{#author :MT start#}
{% endif %}
{#author :MT end#}

{% endfor %}
</ul>
<a class="btn" href="{{ url('product_list') }}?orderby={{eccube_config.eccube_product_order_price_lower}}">お礼の品一覧</a>
</section>

</div>
{% endif %}


{#author :MT start#}
<script>
    $(function(){
        $(document).on('click', 'button#favorite[token-for-anchor]', function(e) {
            const $this = $(this);

            $.ajax({
                type: "POST",
                url: $this.attr('url'),
                data: {
                    '_token': $this.attr('token-for-anchor'),
                    '_method': $this.attr('data-method'),
                    'product_id': $this.attr('data-product_id')
                }
            }).done(function (data) {
                switch ($this.attr('data-method')) {
                    case 'post':
                        $this.attr('url', "{{ url('plg_product_favorite_api_delete') }}");
                        $this.attr('data-method', 'delete');
                        $this.find('.fa-heart').css('color', '#FF004E');
                        break;
                    case 'delete':
                        $this.attr('url', "{{ url('plg_product_favorite_api_add') }}");
                        $this.attr('data-method', 'post');
                        $this.find('.fa-heart').css('color', 'gray');
                        break;
                }
            }).fail(function (data) {
                alert(data.responseJSON);
            })
        });
    });
</script>
{#author :MT end#}
